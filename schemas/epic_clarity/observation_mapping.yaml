# Epic Clarity to FHIR R4 Observation Mapping
# Maps Epic's ORDER_RESULTS and FLOWSHEET tables to FHIR Observation resource

source_system: epic_clarity
source_table: ORDER_RESULTS
target_resource: Observation
description: |
  Maps Epic Clarity lab results and vitals to FHIR R4 Observation.
  Covers ORDER_RESULTS for lab data and IP_FLWSHT_MEAS for flowsheet vitals.

source_schema:
  database: CLARITY
  schema: dbo
  table: ORDER_RESULTS

field_mappings:
  # Primary identifier
  - source: ORDER_ID
    target: id
    transform: to_string
    description: Epic order ID

  # Identifier
  - source: ORDER_ID
    target: identifier[0].value
    transform: to_string
    target_context:
      identifier[0].system: "urn:oid:epic:order"

  # Status
  - source: RESULT_STATUS_C
    target: status
    transform: epic_result_status_to_fhir
    value_mapping:
      1: registered
      2: preliminary
      3: final
      4: amended
      5: corrected
      6: cancelled

  # Category - always laboratory for ORDER_RESULTS
  - source: null
    target: category[0].coding[0].code
    transform: null
    default: laboratory
    target_context:
      category[0].coding[0].system: "http://terminology.hl7.org/CodeSystem/observation-category"

  # Code - LOINC
  - source: COMPONENT_LNC_ID
    target: code.coding[0].code
    transform: null
    target_context:
      code.coding[0].system: "http://loinc.org"

  # Code - display name
  - source: COMPONENT_NAME
    target: code.coding[0].display
    transform: null

  # Code - Epic internal
  - source: COMPONENT_ID
    target: code.coding[1].code
    transform: to_string
    target_context:
      code.coding[1].system: "urn:oid:epic:component"

  # Subject (patient)
  - source: PAT_ID
    target: subject.reference
    transform: to_patient_reference

  # Encounter
  - source: PAT_ENC_CSN_ID
    target: encounter.reference
    transform: to_encounter_reference
    skip_if_null: true

  # Effective date/time
  - source: RESULT_TIME
    target: effectiveDateTime
    transform: datetime_to_fhir_datetime

  # Issued (result timestamp)
  - source: RESULT_TIME
    target: issued
    transform: datetime_to_fhir_instant

  # Value - quantity (numeric)
  - source: ORD_NUM_VALUE
    target: valueQuantity.value
    transform: to_decimal
    condition: "ORD_NUM_VALUE IS NOT NULL"

  # Value - unit
  - source: REFERENCE_UNIT
    target: valueQuantity.unit
    transform: null
    skip_if_null: true

  # Value - string (for non-numeric results)
  - source: ORD_VALUE
    target: valueString
    transform: null
    condition: "ORD_NUM_VALUE IS NULL"

  # Reference range - low
  - source: REF_NORMAL_VALS
    target: referenceRange[0].text
    transform: null
    skip_if_null: true

  # Interpretation
  - source: RESULT_FLAG_C
    target: interpretation[0].coding[0].code
    transform: epic_result_flag_to_fhir
    value_mapping:
      1: N   # Normal
      2: A   # Abnormal
      3: L   # Low
      4: H   # High
      5: LL  # Critical Low
      6: HH  # Critical High

  # Performer
  - source: AUTHRZING_PROV_ID
    target: performer[0].reference
    transform: to_practitioner_reference
    skip_if_null: true

  # Note
  - source: RESULT_CMT
    target: note[0].text
    transform: null
    skip_if_null: true

required_joins:
  - table: ORDER_PROC
    join_on: ORDER_RESULTS.ORDER_PROC_ID = ORDER_PROC.ORDER_PROC_ID
    fields: [PAT_ID, PAT_ENC_CSN_ID, ORDERING_DATE]

  - table: CLARITY_COMPONENT
    join_on: ORDER_RESULTS.COMPONENT_ID = CLARITY_COMPONENT.COMPONENT_ID
    fields: [COMPONENT_NAME, COMPONENT_LNC_ID]

  - table: ZC_RESULT_STATUS
    join_on: ORDER_RESULTS.RESULT_STATUS_C = ZC_RESULT_STATUS.RESULT_STATUS_C
    fields: [NAME]

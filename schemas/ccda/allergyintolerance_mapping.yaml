# C-CDA Allergy Concern Act to FHIR R4 AllergyIntolerance Mapping

source_system: ccda
source_table: AllergyConcernAct
target_resource: AllergyIntolerance

description: |
  Maps C-CDA Allergy Concern Act entries to FHIR R4 AllergyIntolerance.
  XPath: ClinicalDocument/component/structuredBody/component/section[templateId/@root='2.16.840.1.113883.10.20.22.2.6.1']/entry/act

field_mappings:
  # Allergy ID
  - source: entryRelationship/observation/id/@root
    target: identifier[0].system
    transform: oid_to_uri

  - source: entryRelationship/observation/id/@extension
    target: identifier[0].value

  # Clinical Status
  - source: statusCode/@code
    target: clinicalStatus.coding[0].code
    transform: cda_allergy_status_to_fhir
    value_mapping:
      active: active
      completed: resolved
      aborted: inactive
    target_context:
      clinicalStatus.coding[0].system: "http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical"

  # Verification Status
  - source: null
    target: verificationStatus.coding[0].code
    default: confirmed
    target_context:
      verificationStatus.coding[0].system: "http://terminology.hl7.org/CodeSystem/allergyintolerance-verification"

  # Type (allergy vs intolerance)
  - source: entryRelationship/observation/value/@code
    target: type
    transform: cda_allergy_type_to_fhir
    description: Derived from observation value

  # Category
  - source: entryRelationship/observation/participant/participantRole/playingEntity/code/@code
    target: category[0]
    transform: cda_allergen_type_to_category
    value_mapping:
      "419511003": medication  # Drug or medicament
      "235719002": food        # Food intolerance
      "418471000": food        # Propensity to adverse reaction to food
      "232347008": environment # Allergic disorder due to environmental substance

  # Criticality
  - source: entryRelationship/observation/entryRelationship[@typeCode='SUBJ']/observation[templateId/@root='2.16.840.1.113883.10.20.22.4.8']/value/@code
    target: criticality
    transform: cda_severity_to_criticality
    skip_if_null: true

  # Allergen Code
  - source: entryRelationship/observation/participant/participantRole/playingEntity/code/@code
    target: code.coding[0].code

  - source: entryRelationship/observation/participant/participantRole/playingEntity/code/@displayName
    target: code.coding[0].display

  - source: entryRelationship/observation/participant/participantRole/playingEntity/code/@codeSystem
    target: code.coding[0].system
    transform: oid_to_uri

  - source: entryRelationship/observation/participant/participantRole/playingEntity/name
    target: code.text
    skip_if_null: true

  # Onset Date
  - source: entryRelationship/observation/effectiveTime/low/@value
    target: onsetDateTime
    transform: cda_datetime_to_fhir_datetime
    skip_if_null: true

  # Recorded Date
  - source: author/time/@value
    target: recordedDate
    transform: cda_datetime_to_fhir_datetime
    skip_if_null: true

  # Reaction
  - source: entryRelationship/observation/entryRelationship[@typeCode='MFST']/observation/value/@code
    target: reaction[0].manifestation[0].coding[0].code
    skip_if_null: true

  - source: entryRelationship/observation/entryRelationship[@typeCode='MFST']/observation/value/@displayName
    target: reaction[0].manifestation[0].coding[0].display
    skip_if_null: true

  # Reaction Severity
  - source: entryRelationship/observation/entryRelationship[@typeCode='MFST']/observation/entryRelationship/observation/value/@code
    target: reaction[0].severity
    transform: cda_reaction_severity_to_fhir
    skip_if_null: true

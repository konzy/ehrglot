# Cerner Millennium to FHIR R4 AllergyIntolerance Mapping
# Maps Cerner's ALLERGY table to FHIR AllergyIntolerance resource

source_system: cerner_millennium
source_table: ALLERGY
target_resource: AllergyIntolerance
description: |
  Maps Cerner Millennium ALLERGY table to FHIR R4 AllergyIntolerance.

source_schema:
  database: MILLENNIUM
  schema: dbo
  table: ALLERGY

field_mappings:
  - source: ALLERGY_ID
    target: id
    transform: to_string

  - source: ACTIVE_STATUS_CD
    target: clinicalStatus.coding[0].code
    transform: cerner_active_to_clinical_status
    target_context:
      clinicalStatus.coding[0].system: "http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical"

  - source: DATA_STATUS_CD
    target: verificationStatus.coding[0].code
    transform: cerner_data_status_to_verification
    target_context:
      verificationStatus.coding[0].system: "http://terminology.hl7.org/CodeSystem/allergyintolerance-verification"

  - source: REACTION_CLASS_CD
    target: type
    transform: cerner_reaction_class_to_type
    value_mapping:
      1: allergy
      2: intolerance

  - source: SUBSTANCE_TYPE_CD
    target: category[0]
    transform: cerner_substance_type_to_category
    value_mapping:
      1: medication
      2: food
      3: environment

  - source: SEVERITY_CD
    target: criticality
    transform: cerner_severity_to_criticality
    value_mapping:
      1: low
      2: high
      3: unable-to-assess

  - source: SUBSTANCE_NOMENCLATURE_ID
    target: code.coding[0].code
    transform: lookup_rxnorm_from_nomenclature
    skip_if_null: true

  - source: SUBSTANCE_FTDESC
    target: code.text
    transform: null

  - source: PERSON_ID
    target: patient.reference
    transform: to_patient_reference

  - source: ONSET_DT_TM
    target: onsetDateTime
    transform: datetime_to_fhir_datetime
    skip_if_null: true

  - source: BEG_EFFECTIVE_DT_TM
    target: recordedDate
    transform: datetime_to_fhir_datetime

  - source: CREATED_PRSNL_ID
    target: recorder.reference
    transform: to_practitioner_reference
    skip_if_null: true

  - source: REACTION_TEXT
    target: reaction[0].manifestation[0].text
    transform: null
    skip_if_null: true

required_joins:
  - table: NOMENCLATURE
    join_on: ALLERGY.SUBSTANCE_NOMENCLATURE_ID = NOMENCLATURE.NOMENCLATURE_ID
    fields: [SOURCE_STRING, SOURCE_IDENTIFIER]
